name: Bump Version and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install uv
        run: python -m pip install uv

      - name: Install toml
        run: pip install toml

      - name: Bump version
        id: bump_version
        run: |
          import toml
          import json
          import os
          import subprocess
          
          # Read current version from pyproject.toml
          with open('pyproject.toml', 'r') as f:
              data = toml.load(f)
          
          current_version = data['project']['version']
          print(f"Current version: {current_version}")
          
          # Get the latest tag from remote to avoid conflicts
          try:
              subprocess.run(['git', 'fetch', '--tags'], check=True)
              latest_tag = subprocess.check_output(['git', 'describe', '--tags', '--abbrev=0'], text=True).strip()
              if latest_tag.startswith('v'):
                  latest_tag = latest_tag[1:]
              print(f"Latest remote tag version: {latest_tag}")
              
              # Use the latest tag version if it's newer than the current version
              if latest_tag > current_version:
                  print(f"Remote tag version {latest_tag} is newer than current version {current_version}")
                  new_version = latest_tag
              else:
                  # Split version into parts and increment patch version
                  major, minor, patch = map(int, current_version.split('.'))
                  patch += 1
                  new_version = f"{major}.{minor}.{patch}"
                  print(f"New version: {new_version}")
          except Exception as e:
              print(f"Error fetching remote tags: {e}")
              # Fallback to local version increment
              major, minor, patch = map(int, current_version.split('.'))
              patch += 1
              new_version = f"{major}.{minor}.{patch}"
              print(f"Fallback to new version: {new_version}")
          
          # Update pyproject.toml
          data['project']['version'] = new_version
          with open('pyproject.toml', 'w') as f:
              toml.dump(data, f)
          
          # Update version in fastx_tui_plugin.py
          plugin_file_path = 'fastx_tui_plugin.py'
          with open(plugin_file_path, 'r', encoding='utf-8') as f:
              plugin_content = f.read()
          
          # Replace version string in the file
          plugin_content = plugin_content.replace(f'version="{current_version}"', f'version="{new_version}"')
          
          # Update last_updated to current date
          from datetime import datetime
          current_date = datetime.now().strftime("%Y-%m-%d")
          # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢last_updatedå€¼
          import re
          plugin_content = re.sub(r'last_updated="[0-9]{4}-[0-9]{2}-[0-9]{2}"', f'last_updated="{current_date}"', plugin_content)
          
          # Update repository URL if it's empty
          if 'repository=""' in plugin_content:
              # è·å–å½“å‰ä»“åº“URL
              repo_url = subprocess.check_output(['git', 'config', '--get', 'remote.origin.url'], text=True).strip()
              plugin_content = plugin_content.replace('repository=""', f'repository="{repo_url}"')
          
          # Update homepage URL if it's empty
          if 'homepage=""' in plugin_content:
              # ä½¿ç”¨ä»“åº“URLä½œä¸ºhomepage
              repo_url = subprocess.check_output(['git', 'config', '--get', 'remote.origin.url'], text=True).strip()
              # è½¬æ¢ä¸ºHTTPSæ ¼å¼ï¼ˆå¦‚æœæ˜¯SSHæ ¼å¼ï¼‰
              if repo_url.startswith('git@github.com:'):
                  repo_url = repo_url.replace('git@github.com:', 'https://github.com/')
              plugin_content = plugin_content.replace('homepage=""', f'homepage="{repo_url}"')
          
          with open(plugin_file_path, 'w', encoding='utf-8') as f:
              f.write(plugin_content)
          print(f"Updated version and metadata in {plugin_file_path}")
          
          # ä½¿ç”¨æ–°çš„ GITHUB_OUTPUT è¯­æ³•
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'new_version={new_version}\n')
        shell: python

      - name: Debug output
        run: |
          echo "bump_version.new_version: ${{ steps.bump_version.outputs.new_version }}"
          if [ -z "${{ steps.bump_version.outputs.new_version }}" ]; then
            echo "ERROR: new_version is empty!"
            exit 1
          fi

      - name: Commit and push version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml fastx_tui_plugin.py
          git commit -m "Bump version to v${{ steps.bump_version.outputs.new_version }}"
          git push origin main

      - name: Create tag
        id: create_tag
        run: |
          # å…ˆæ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦æœ‰æ•ˆ
          new_version="${{ steps.bump_version.outputs.new_version }}"
          echo "New version from previous step: $new_version"
          
          if [ -z "$new_version" ]; then
            echo "ERROR: new_version is empty!"
            exit 1
          fi
          
          tag_name="v${new_version}"
          echo "Creating tag: $tag_name"
          
          # éªŒè¯ tag æ ¼å¼
          if [[ ! $tag_name =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid tag format: $tag_name"
            exit 1
          fi
          
          git tag $tag_name
          git push origin $tag_name
          
          # ä½¿ç”¨æ–°çš„ GITHUB_OUTPUT è¯­æ³•
          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT

    outputs:
      tag_name: ${{ steps.create_tag.outputs.tag_name }}
      new_version: ${{ steps.bump_version.outputs.new_version }}

  build-package:
    needs: bump-version
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.bump-version.outputs.tag_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install uv
        run: python -m pip install uv

      - name: Sync dependencies with uv
        run: uv sync

      - name: Install build tools
        run: uv add build

      - name: Build wheel and sdist
        run: uv run python -m build

      - name: List artifacts
        run: ls -la dist/

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package-build
          path: |
            dist/*.whl
            dist/*.tar.gz
          retention-days: 7

  create-release:
    needs: [bump-version, build-package]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.bump-version.outputs.tag_name }}

      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          name: package-build

      - name: Prepare release files
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release-files
          
          # å¤åˆ¶åŒ…æ–‡ä»¶
          mv *.whl release-files/ 2>/dev/null || true
          mv *.tar.gz release-files/ 2>/dev/null || true
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "Release files:"  
          ls -la release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.bump-version.outputs.tag_name }}
          name: "Release ${{ needs.bump-version.outputs.tag_name }}"
          body: |
            # Release v${{ needs.bump-version.outputs.new_version }}
            
            ğŸš€ Automated release created on ${{ github.event.head_commit.timestamp }}
            
            ## ğŸ“¦ Assets
            
            - **FastX-Tui-Plugin-Example-${{ needs.bump-version.outputs.new_version }}-py3-none-any.whl** - Python wheel
            - **FastX-Tui-Plugin-Example-${{ needs.bump-version.outputs.new_version }}.tar.gz** - Source distribution
            
            ## ğŸ”§ Installation
            
            ```bash
            # Using pip
            pip install FastX-Tui-Plugin-Example-${{ needs.bump-version.outputs.new_version }}-py3-none-any.whl
            
            # Using uv
            uv add FastX-Tui-Plugin-Example-${{ needs.bump-version.outputs.new_version }}-py3-none-any.whl
            ```
            
            ## ğŸ“ Changes
            - Version bump to ${{ needs.bump-version.outputs.new_version }}
            - Automated build and release
            
            ---
            
            *This release was automatically generated by GitHub Actions.*
          draft: false
          prerelease: false
          files: |
            release-files/*
          token: ${{ secrets.GITHUB_TOKEN }}
          generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
